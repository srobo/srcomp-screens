<link rel="import" href="../../bower_components/polymer/polymer.html" />

<link rel="import" href="../sr-clock/component.html" />
<link rel="import" href="../sr-corner-clock/component.html" />
<link rel="import" href="../sr-delay/component.html" />

<polymer-element name="sr-producer" attributes="arena comp">
    <template>
        <style>
            :host {
                display: flex;
                display: -webkit-flex;
                flex-direction: column;
                -webkit-flex-direction: column;
                align-items: center;
                -webkit-align-items: center;
                justify-content: space-between;
                height: 100%;
            }

            #title {
                margin: 0.6em 0 0;
            }

            sr-corner-clock h1 {
                margin: 0;
            }

            #time {
                flex: 0 0 auto;
                -webkit-flex: 0 0 auto;

                width: 100%;

                display: flex;
                display: -webkit-flex;
                flex-direction: row;
                -webkit-flex-direction: row;

                border-top: 1px solid white;
                background: rgb(50, 50, 50);
            }

            sr-clock, sr-delay {
                flex: 1 1 auto;
                -webkit-flex: 1 1 auto;

                text-align: center;

                margin: 0.1em;
                font-size: 3.6em;
            }

            sr-corner-clock h1 {
                font-size: 3.6em;
            }
        </style>

        <h1 id="title">Producer</h1>

        <div>
            <h2>Match {{ match.num }}</h2>
            <sr-corner-clock id="clock"></sr-corner-clock>
        </div>


        <div id="time">
            <sr-clock></sr-clock>
            <sr-delay id="delay"></sr-delay>
        </div>
    </template>

    <script>
        var reload = function() {
            if (this.comp == null || this.arena == null) {
                return;
            }

            this.$.delay.comp = this.comp;

            this.comp.stream.addEventListener('match', function(e) {
                var matches = e.detail.filter(function(match) {
                    return match.arena === this.arena;
                }.bind(this));

                if (matches.length) {
                    this.match = matches[0];
                } else {
                    this.match = null;

                    this.comp.api.getUpcomingMatches(this.arena, function(matches) {
                        // only update if we haven't since updated the match
                        if (this.match == null && matches.length) {
                            this.match = matches[0];
                        }
                    }.bind(this));
                }
            }.bind(this));

            this.comp.stream.addEventListener('knockouts', function() {
                var updateMatch = function(matches) {
                    // only update if it's the same match
                    var newMatch = matches[0];
                    if (this.match != null && newMatch != null && this.match.num == newMatch.num) {
                        this.match = newMatch;
                    }
                }.bind(this);

                if (this.match) {
                    this.comp.api.getMatch(this.arena, this.match.num, updateMatch);
                } else {
                    this.comp.api.getUpcomingMatches(this.arena, updateMatch);
                }
            }.bind(this));
        };
        Polymer({
            comp: null,
            compChanged: reload,
            arenaChanged: reload,
            match: undefined,
            matchChanged: function() {
                this.$.clock.match = this.match;
                this.fire('match', this.match);
            }
        });
    </script>
</polymer-element>
